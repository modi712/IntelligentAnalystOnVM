<!DOCTYPE html>
<html>
<head>
    <title>Chatbot Interface</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Analyst</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .glass-panel {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .hidden {
            display: none;
        }
        .report-row-animation {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        th:first-child {
            border-top-left-radius: 0.5rem;
        }

        th:last-child {
            border-top-right-radius: 0.5rem;
        }

        tr:last-child td:first-child {
            border-bottom-left-radius: 0.5rem;
        }

        tr:last-child td:last-child {
            border-bottom-right-radius: 0.5rem;
        }

        #report-content-table tr:nth-child(2n+1):not(.bg-gray-100) {
            background-color: rgba(249, 250, 251, 0.8);
        }

        #report-content-table td {
            vertical-align: top;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }

        #report-display-section {
            animation: fadeIn 0.5s ease-in-out;
        }

        .category-row {
            font-weight: 600;
            background-color: #f3f4f6;
        }

        #report-content-table td ul {
            margin: 0;
            padding-left: 1.5rem;
        }

        #report-content-table td li {
            margin-bottom: 0.5rem;
        }

        #report-content-table td strong {
            font-weight: 600;
        }

        #chat-messages {
            line-height: 1.5;
        }

        #chat-messages ul {
            padding-left: 1.5rem;
            margin: 0.5rem 0;
        }

        #chat-messages li {
            margin-bottom: 0.3rem;
        }

        #chat-messages strong {
            font-weight: 600;
        }
        #user-input {
            min-height: 42px;
            max-height: 200px;
            transition: height 0.1s ease-in-out;
            line-height: 1.5;
            margin-bottom: 0.2rem;
            margin-left:0.2rem
        }

        .chat-input-container {
            display: flex;
            align-items: flex-end; /* Align items to bottom */
        }
    </style>
</head>
<body class="w-full min-h-screen bg-gradient-to-b from-gray-100 to-gray-300 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Quanfia bot v2.0</h1>
                <p class="text-gray-600">Generate and analyze reports with AI-powered insights</p>
            </div>
            <div>
                {% if request.session.user %}
                <div class="flex items-center space-x-4">
                    {% comment %} <span class="text-sm text-gray-700">Hi, {{ request.session.user.full_name }}</span> {% endcomment %}
                    <a href="{% url 'logout' %}" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-gray-200 text-gray-800 shadow hover:bg-gray-300 h-8 px-4 py-2">
                        Logout
                    </a>
                </div>
                {% endif %}
            </div>
        </header>


         <!-- Django Messages -->
        {% if messages %}
        <div class="messages-container mb-6">
            {% for message in messages %}
            <div class="p-4 mb-3 rounded-md {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-200{% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-200{% else %}bg-blue-100 text-blue-700 border border-blue-200{% endif %} animate-fade-in">
                <div class="flex items-center">
                    {% if message.tags == 'success' %}
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                    {% elif message.tags == 'error' %}
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    {% else %}
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zm-1 9a1 1 0 01-1-1v-2a1 1 0 112 0v2a1 1 0 01-1 1z" clip-rule="evenodd"></path></svg>
                    {% endif %}
                    <span>{{ message }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="glass-panel rounded-xl overflow-hidden animate-fade-up" style="animation-delay: 0.1s;">
                <div class="pb-3 p-6">
                    <h2 class="text-xl font-semibold text-gray-800">Configure Analysis</h2>
                </div>
                <div class="space-y-6 p-6 pt-0">
                    <div class="space-y-2">
                        <label for="company" class="text-sm font-medium text-gray-700">
                            Select Company
                        </label>
                        <select id="company" class="w-full h-10 rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1">
                            {% for company in companies %}
                                <option>{{ company }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mt-4">
                        <form id="add-company-form" class="flex items-center space-x-2 w-full">
                            {% csrf_token %}
                            <div class="flex w-full">
                                <input type="text" id="new-company-input" placeholder="Add new company" class="flex-grow border border-gray-300 rounded-l-md px-3 py-3 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <button type="submit" class="bg-blue-500 text-white px-3 py-3 rounded-r-md hover:bg-blue-600 text-sm font-medium">Add</button>
                            </div>
                        </form>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">Knowledge Base</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="use-existing-btn" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-blue-500 text-white shadow hover:bg-blue-500/90 h-9 px-4 py-2">Use Existing</button>
                            <button id="create-new-btn" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-blue-600 bg-transparent shadow-sm hover:bg-gray-100 hover:text-gray-900 h-9 px-4 py-2">Create New</button>
                        </div>
                    </div>
                    
                    <!-- Knowledge base selection - shown when "Use Existing" is clicked -->
                    <div id="existing-kb-section" class="space-y-2 hidden">
                        <label for="kb-select" class="text-sm font-medium text-gray-700">
                            Select Knowledge Base
                        </label>
                        <select id="kb-select" class="w-full h-10 rounded-md border border-gray-300 bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1">
                            <!-- Will be populated with AJAX -->
                        </select>
                    </div>

                     <button id="generateExcelReport" class="w-full inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-blue-500 text-white shadow hover:bg-blue-500/90 h-10 rounded-md px-8">
                        Generate Report
                    </button> 
{% comment %} 
                    <button id="generateQAReport" class="w-full inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-green-500 text-white shadow hover:bg-green-600 h-10 rounded-md px-8">
                        Generate Q&A Report
                    </button>
                    <div class="mt-4 space-y-2">
                        <label for="ground-truths-file" class="text-sm font-medium text-gray-700">
                            Ground Truths File (Optional - For RAGAS Evaluation)
                        </label>
                        <div class="flex items-center">
                            <input type="file" id="ground-truths-file" accept=".md,.txt" class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100">
                        </div>
                    <p class="text-xs text-gray-500">If provided, the report will include RAGAS evaluation metrics</p>
                </div>

                <div class="mt-2">
                    <button id="show-gt-format" class="text-xs text-blue-600 hover:text-blue-800">
                        Help with ground truths format
                    </button>
                </div> {% endcomment %}

                    
                </div> 
                
            </div>

            <!-- Chat Interface Panel -->
             <div id="chat-panel" class="glass-panel rounded-xl overflow-hidden animate-fade-up md:col-span-2" style="animation-delay: 0.3s;">
                <div class="pb-3 p-6">
                    <h2 class="text-xl font-semibold text-gray-800">Chatbot</h2>
                </div>
                <div class="p-6 pt-0">
                    <div id="chat-messages" class="h-80 overflow-y-auto  p-4 border rounded-lg">
                        <p class="text-gray-500">Chat interface will be displayed here.</p>
                    </div>
                </div>
                <div class="chat-input-container flex mb-2">
                    <textarea 
                        id="user-input" 
                        class="flex-grow rounded-l-md border border-gray-300 bg-white bg-opacity-90 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none overflow-auto" 
                        placeholder="Type your message here... (Shift+Enter for new line)" 
                        rows="1"
                    ></textarea>
                    <button id="send-message" class="h-12 px-2 bg-blue-500 text-white rounded-r-md hover:bg-blue-600 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    Send
                    </button>
                </div>
               
            </div> 
        </div>

<!-- Reports History Section -->
        <div class="max-w-7xl mx-auto mt-8">
            <div class="glass-panel rounded-xl overflow-hidden animate-fade-up" style="animation-delay: 0.4s;">
                <div class="pb-3 p-6 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-800">Generated Reports</h2>
                    <button id="refresh-reports" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-blue-100 text-blue-700 shadow hover:bg-blue-200 h-8 px-3 py-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                        </svg>
                        Refresh
                    </button>
                </div>
                <div class="p-6 pt-0">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Knowledge Base</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reports-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">Loading reports...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="no-reports-message" class="hidden text-center py-8 text-gray-500">
                        No reports found. Generate a report to see it here.
                    </div>
                </div>
            </div>
        </div>
        <!-- Add this after the Reports History table section -->
        <div id="report-display-section" class="max-w-7xl mx-auto mt-8 hidden">
            <div class="glass-panel rounded-xl overflow-hidden animate-fade-up" style="animation-delay: 0.5s;">
                <div class="pb-3 p-6 flex justify-between items-center">
                    <h2 id="report-title" class="text-xl font-semibold text-gray-800">Investment Analysis Report</h2>
                    <button id="close-report" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-gray-200 text-gray-700 shadow hover:bg-gray-300 h-8 px-3 py-2">
                        Close Report
                    </button>
                </div>
                <div class="p-6 pt-0">
                    <div class="overflow-x-auto">
                        <table id="report-content-table" class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Category</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Question</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-5/12">Answer</th>
                                </tr>
                            </thead>
                            <tbody id="report-content-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">Loading report content...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

         // Declare global variables at the top
        let companySelect, useExistingBtn, createNewBtn, existingKbSection, kbSelect, generateReportBtn, userInput, sendMessageBtn, chatMessages,refreshReportsBtn, reportsTableBody, noReportsMessage,generateQAReportBtn;


        

        // Function to get CSRF token from cookies
            function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }


            // Function to show alert messages
             function showAlert(message, type) {
                console.log(`${type}: ${message}`);
                const alertDiv = document.createElement('div');
                alertDiv.className = `p-4 mb-3 rounded-md animate-fade-in ${
                    type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 
                    type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' : 
                    'bg-blue-100 text-blue-700 border border-blue-200'
                }`;
                alertDiv.textContent = message; 

             // Add to page if there's a messages container
                const messagesContainer = document.querySelector('.messages-container');
                if (messagesContainer) {
                    messagesContainer.appendChild(alertDiv);
                    // Auto-remove after 5 seconds
                    setTimeout(() => alertDiv.remove(), 5000);
                } else {
                    // Fallback - use alert
                    alert(`${type.toUpperCase()}: ${message}`);
                }
            } 


            // Function to load knowledge bases for selected company
            function loadKnowledgeBases() {
                const company = companySelect.value;
                console.log("Loading knowledge bases for company:", company);
                
                // Clear current options
                kbSelect.innerHTML = '';
                
                // Add loading option
                const loadingOption = document.createElement('option');
                loadingOption.textContent = 'Loading...';
                loadingOption.disabled = true;
                kbSelect.appendChild(loadingOption);
                const formData1 = new FormData();
                formData1.append('company', companySelect.value);
                // Make the AJAX request with vanilla JavaScript
                fetch(`/get-knowledge-bases/?company=${company}`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Clear the dropdown
                        kbSelect.innerHTML = '';
                        
                        // Add default option
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'Select a knowledge base';
                        kbSelect.appendChild(defaultOption);
                        
                        // Check if we have knowledge bases
                        if (data.knowledge_bases && data.knowledge_bases.length > 0) {
                            // Add each knowledge base to the dropdown
                            data.knowledge_bases.forEach(kb => {
                                const option = document.createElement('option');
                                option.value = kb;
                                option.textContent = kb;
                                kbSelect.appendChild(option);
                            });
                            console.log(`Loaded ${data.knowledge_bases.length} knowledge bases`);
                        } else {
                            // No knowledge bases found
                            const noneOption = document.createElement('option');
                            noneOption.disabled = true;
                            noneOption.textContent = 'No knowledge bases found';
                            kbSelect.appendChild(noneOption);
                            console.log("No knowledge bases found");
                        }
                    })
                    .catch(error => {
                        console.error('Error loading knowledge bases:', error);
                        kbSelect.innerHTML = '';
                        const errorOption = document.createElement('option');
                        errorOption.textContent = 'Error loading knowledge bases';
                        kbSelect.appendChild(errorOption);
                    });
            }



            // Send message functionality - using the correct IDs
            function sendMessage() {
                const messageText = userInput.value.trim();
                const company = companySelect.value;
                const kbId = kbSelect.value;
                
                if (!messageText) return;
                
                // Log what we're sending for debugging
                console.log("Sending message:", {
                    user_input: messageText,
                    company: company,
                    kb_id: kbId
                });
                
                // Clear the input field
                userInput.value = '';
                
                // Display user message
                const userDiv = document.createElement('div');
                userDiv.className = 'mb-3';
                userDiv.innerHTML = `<span class="font-bold">You:</span> ${messageText}`;
                chatMessages.appendChild(userDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Create and send the request
                const formData = new FormData();
                formData.append('user_input', messageText);
                formData.append('company', company);
                formData.append('kb_id', kbId);
                
                fetch('/chat/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Display the bot response
                    const botDiv = document.createElement('div');
                    botDiv.className = 'mb-3 bg-gray-100 p-2 rounded';
                    botDiv.innerHTML = `<span class="font-bold">Bot:</span> ${formatMarkdown(data.response)}`;
                    chatMessages.appendChild(botDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                })
                .catch(error => {
                    console.error('Error:', error);
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'mb-3 bg-red-100 p-2 rounded text-red-700';
                    errorDiv.innerHTML = '<span class="font-bold">Error:</span> Sorry, there was an error processing your request.';
                    chatMessages.appendChild(errorDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }


            // Function to load reports
            function loadReports() {

                reportsTableBody.innerHTML = '';
                fetch('/get-session-reports/', {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.reports.length > 0) {
                        // Display reports
                        reportsTableBody.innerHTML = '';
                        noReportsMessage.classList.add('hidden');
                        
                        data.reports.forEach(report => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50 report-row-animation';
                            
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${report.company}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.kb_name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.report_type.toUpperCase()}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${report.created_at}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button class="text-blue-600 hover:text-blue-900 mr-3 view-report" data-path="${report.report_path}">View</button>
                                    <button class="text-green-600 hover:text-green-900 download-report" data-path="${report.report_path}">Download</button>
                                </td>
                            `;
                            
                            reportsTableBody.appendChild(row);
                        });

                         // Add event listeners for the buttons
                        addReportButtonListeners();
                    } else {
                        // No reports found
                        reportsTableBody.innerHTML = '';
                        noReportsMessage.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error loading report content:', error);
                    reportsTableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-sm text-red-500">
                                Error loading reports: ${error.message}
                            </td>
                        </tr>
                    `;
                });
            }

            // // Extract the event listener setup to a separate function for reuse

            function addReportButtonListeners() {
                        // Update the view-report event listeners in loadReports function
                        document.querySelectorAll('.view-report').forEach(button => {
                            button.addEventListener('click', function() {
                                const path = this.getAttribute('data-path');
                                const reportType = this.closest('tr').querySelector('td:nth-child(3)').textContent.toLowerCase();

                                // If this is a QA report, use a different display mode
                                if (reportType === 'qa_excel') {
                                    // Custom display for QA reports
                                    displayQAReport(path);
                                } else {
                                    // Standard report display
                                    // Get report company name and KB name for the title
                                    const row = this.closest('tr');
                                    const companyName = row.querySelector('td:first-child').textContent;
                                    const kbName = row.querySelector('td:nth-child(2)').textContent;
                                    
                                    // Show loading state
                                    document.getElementById('report-content-body').innerHTML = `
                                        <tr>
                                            <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">
                                                <div class="flex justify-center items-center">
                                                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                    </svg>
                                                    Loading report content...
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                    
                                    // Set the report title
                                    document.getElementById('report-title').textContent = `${companyName} - Investment Analysis Report`;
                                    
                                    // Show the report display section
                                    document.getElementById('report-display-section').classList.remove('hidden');
                                    
                                    // Scroll to the report section
                                    document.getElementById('report-display-section').scrollIntoView({ behavior: 'smooth' });
                                    
                                    // Fetch the report content
                                    fetch(`/get-report-content/${encodeURIComponent(path)}/`, {
                                        method: 'GET',
                                        headers: {
                                            'X-CSRFToken': getCookie('csrftoken')
                                        }
                                    })
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('Network response was not ok');
                                        }
                                        return response.json();
                                    })
                                    // Then update your report content display code
                                    .then(data => {
                                        if (data.success) {
                                            // Clear existing table content
                                            const reportContentBody = document.getElementById('report-content-body');
                                            reportContentBody.innerHTML = '';
                                            
                                            // Loop through categories and questions to populate the table
                                            data.report_data.categories.forEach(category => {
                                                // Add category row
                                                const categoryRow = document.createElement('tr');
                                                categoryRow.className = 'bg-gray-100';
                                                categoryRow.innerHTML = `
                                                    <td colspan="3" class="px-6 py-3 font-medium text-gray-900">${category.name}</td>
                                                `;
                                                reportContentBody.appendChild(categoryRow);
                                                
                                                // Add question and answer rows
                                                category.questions.forEach(item => {
                                                    const questionRow = document.createElement('tr');
                                                    questionRow.innerHTML = `
                                                        <td class="px-6 py-4 text-sm text-gray-500"></td>
                                                        <td class="px-6 py-4 text-sm text-gray-900">${item.question}</td>
                                                        <td class="px-6 py-4 text-sm text-gray-600">${formatMarkdown(item.answer)}</td>
                                                    `;
                                                    reportContentBody.appendChild(questionRow);            
                                                });
                                            });
                                        } else {
                                            // Show error
                                            document.getElementById('report-content-body').innerHTML = `
                                                <tr>
                                                    <td colspan="3" class="px-6 py-4 text-center text-sm text-red-500">
                                                        Error: ${data.message}
                                                    </td>
                                                </tr>
                                            `;
                                        }
                                    })
                                }    
                            });

                            // Add this function to handle QA report display
                            function displayQAReport(path) {
                                // Show loading state
                                document.getElementById('report-content-body').innerHTML = `
                                    <tr>
                                        <td colspan="3" class="px-6 py-4 text-center text-sm text-gray-500">
                                            <div class="flex justify-center items-center">
                                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                Loading Q&A report content...
                                            </div>
                                        </td>
                                    </tr>
                                `;

                                // Update table headers for QA format
                                const reportTable = document.getElementById('report-content-table');
                                const tableHead = reportTable.querySelector('thead tr');
                                tableHead.innerHTML = `
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/6">Question Type</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Question</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Analyst's Answer</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">AI Answer</th>
                                `;
                                
                                // Show the report display section
                                document.getElementById('report-display-section').classList.remove('hidden');
                                document.getElementById('report-title').textContent = "Q&A Analysis Report";
                                
                                // Scroll to the report section
                                document.getElementById('report-display-section').scrollIntoView({ behavior: 'smooth' });
                                
                                // Fetch the report content (via the same endpoint as before, the backend will handle the different format)
                                fetch(`/get-report-content/${encodeURIComponent(path)}/`, {
                                    method: 'GET',
                                    headers: {
                                        'X-CSRFToken': getCookie('csrftoken')
                                    }
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Network response was not ok');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    if (data.success) {
                                        // Clear existing table content
                                        const reportContentBody = document.getElementById('report-content-body');
                                        reportContentBody.innerHTML = '';
                                        
                                        // Extract the qa_data from the response
                                        const qaData = data.report_data.qa_data;
                                        
                                        // Loop through categories and questions to populate the table
                                        for (const [category, questions] of Object.entries(qaData)) {
                                            // Add category row
                                            const categoryRow = document.createElement('tr');
                                            categoryRow.className = 'bg-gray-100';
                                            categoryRow.innerHTML = `
                                                <td colspan="4" class="px-6 py-3 font-medium text-gray-900">${category}</td>
                                            `;
                                            reportContentBody.appendChild(categoryRow);
                                            
                                            // Add question and answer rows
                                            questions.forEach(item => {
                                                const questionRow = document.createElement('tr');
                                                questionRow.innerHTML = `
                                                    <td class="px-6 py-4 text-sm text-gray-500">${category}</td>
                                                    <td class="px-6 py-4 text-sm text-gray-900">${item.question}</td>
                                                    <td class="px-6 py-4 text-sm text-gray-600">${formatMarkdown(item.analyst_answer)}</td>
                                                    <td class="px-6 py-4 text-sm text-gray-600">${formatMarkdown(item.ai_answer)}</td>
                                                `;
                                                reportContentBody.appendChild(questionRow);
                                            });
                                        }
                                    } else {
                                        // Show error
                                        document.getElementById('report-content-body').innerHTML = `
                                            <tr>
                                                <td colspan="4" class="px-6 py-4 text-center text-sm text-red-500">
                                                    Error: ${data.message}
                                                </td>
                                            </tr>
                                        `;
                                    }
                                })
                                .catch(error => {
                                    console.error('Error loading report content:', error);
                                    document.getElementById('report-content-body').innerHTML = `
                                        <tr>
                                            <td colspan="4" class="px-6 py-4 text-center text-sm text-red-500">
                                                Error loading report content. Please try again.
                                            </td>
                                        </tr>
                                    `;
                                });
                            }
                                
                        // Add event listeners for download buttons                        
                        document.querySelectorAll('.download-report').forEach(button => {
                            button.addEventListener('click', function() {
                                const path = this.getAttribute('data-path');
                                const downloadUrl = `/download-report/${encodeURIComponent(path)}/`;
                                window.location.href = downloadUrl;
                            });
                        });
                    });
            }
                


            // Add this function to your JavaScript to process markdown text
            function formatMarkdown(text) {
                if (!text) return '';
                
                // Process bullet points
                text = text.replace(/•\s(.*?)(?=(\n•|\n\n|$))/gs, '<li>$1</li>');
                text = text.replace(/\*\s(.*?)(?=(\n\*|\n\n|$))/gs, '<li>$1</li>');
                text = text.replace(/\-\s(.*?)(?=(\n\-|\n\n|$))/gs, '<li>$1</li>');
                
                // Add list tags where appropriate
                if (text.includes('<li>')) {
                    text = '<ul>' + text + '</ul>';
                    // Fix nested lists
                    text = text.replace(/<\/li><ul>/g, '<ul>');
                    text = text.replace(/<\/ul><li>/g, '</ul></li><li>');
                }
                
                // Process bold text
                text = text.replace(/\*\*(.*?)\*\*?/g, '<strong>$1</strong>');
                
                // Process line breaks
                text = text.replace(/\n\n/g, '<br><br>');
                text = text.replace(/\n/g, '<br>');
                
                // Fix duplicate line breaks
                text = text.replace(/<br><br><br>/g, '<br><br>');
                
                return text;
            }


            function generateQAReport() {
                const company = companySelect.value;
                const kbSelect = document.getElementById('kb-select');
                
                if (!company) {
                    showAlert('Please select a company first.', 'error');
                    return;
                }
                
                if (!kbSelect.value) {
                    showAlert('Please select a knowledge base first.', 'error');
                    return;
                }

                // Get the ground truths file if uploaded
                const groundTruthsFile = document.getElementById('ground-truths-file').files[0];
                let groundTruthsPath = null;
                
                const processReport = () => {
                    showAlert('Generating Q&A report... This may take a few minutes.', 'info');
                    
                    fetch('/generate-qa-report/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            company: company,
                            kb_name: kbSelect.options[kbSelect.selectedIndex].text,
                            ground_truths_path: groundTruthsPath
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('Q&A report generated successfully!' + 
                                (groundTruthsPath ? ' (with RAGAS evaluation)' : ''), 'success');
                            
                            // Create download link for the report
                            const downloadPath = data.report_path;
                            const downloadUrl = `/download-report/${encodeURIComponent(downloadPath)}/`;
                            
                            // Create and trigger download
                            window.location.href = downloadUrl;
                            
                            // Update the reports list after a delay
                            setTimeout(() => {
                                loadReports();
                            }, 3000);
                        } else {
                            showAlert(`Error: ${data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('An error occurred. Please try again.', 'error');
                    });
                };
                
                // If ground truths file is uploaded, save it first
                if (groundTruthsFile) {
                    const formData = new FormData();
                    formData.append('file', groundTruthsFile);
                    formData.append('company', company);
                    formData.append('kb_name', kbSelect.options[kbSelect.selectedIndex].text);
                    
                    fetch('/upload-ground-truths/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            groundTruthsPath = data.file_path;
                            processReport();
                        } else {
                            showAlert(`Error uploading ground truths: ${data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error uploading ground truths file.', 'error');
                    });
                } else {
                    // No ground truths file, proceed without RAGAS evaluation
                    processReport();
                }
            };













        document.addEventListener('DOMContentLoaded', function() {
            companySelect = document.getElementById('company');
            useExistingBtn = document.getElementById('use-existing-btn');
            createNewBtn = document.getElementById('create-new-btn');
            existingKbSection = document.getElementById('existing-kb-section');
            kbSelect = document.getElementById('kb-select');
            generateReportBtn = document.getElementById('generateExcelReport');
            userInput = document.getElementById('user-input');
            sendMessageBtn = document.getElementById('send-message');
            chatMessages = document.getElementById('chat-messages');
            refreshReportsBtn = document.getElementById('refresh-reports');
            reportsTableBody = document.getElementById('reports-table-body');
            noReportsMessage = document.getElementById('no-reports-message');
            generateQAReportBtn = document.getElementById('generateQAReport');



             // Fix for the ground truths format help button
            const showGtFormatBtn = document.getElementById('show-gt-format');
            if (showGtFormatBtn) {
                showGtFormatBtn.addEventListener('click', function() {
                    const helpText = `
                        <div class="text-sm">
                            <h3 class="font-bold mb-2">Ground Truths File Format</h3>
                            <p>Create a Markdown (.md) file with the following format:</p>
                            <pre class="bg-gray-100 p-2 mt-2 mb-3 text-xs overflow-auto">
        ## Question 1:
        What is the full name of the AMD?

        ## Ground Truth:
        ADVANCED MICRO DEVICES, INC.

        ## Question 2:
        What are the main products of AMD?

        ## Ground Truth:
        AMD's products include x86 microprocessors...</pre>
                            <p class="font-bold">Important:</p>
                            <ul class="list-disc pl-5 mb-2">
                                <li>Questions must match those in the Q&A report exactly</li>
                                <li>Format must follow the exact pattern shown above</li>
                                <li>Include ## Question and ## Ground Truth markers</li>
                            </ul>
                        </div>
                    `;
                    
                    // Show modal or alert with the help text
                    showAlert(helpText, 'info');
                });
            }

            refreshReportsBtn.addEventListener('click', loadReports);

                if (generateQAReportBtn) {
                    generateQAReportBtn.addEventListener('click', generateQAReport);
                }

            // Load reports initially
            loadReports();

            document.getElementById('close-report').addEventListener('click', function() {
                document.getElementById('report-display-section').classList.add('hidden');
            });
            const djangoMessages = document.querySelectorAll('.messages-container > div');
            djangoMessages.forEach(function(message) {
                    // Add a close button
                    const closeBtn = document.createElement('button');
                    closeBtn.innerHTML = '&times;';
                    closeBtn.className = 'close-btn';
                    closeBtn.style.float = 'right';
                    closeBtn.style.background = 'none';
                    closeBtn.style.border = 'none';
                    closeBtn.style.fontSize = '20px';
                    closeBtn.style.cursor = 'pointer';
                    closeBtn.style.marginLeft = '10px';
                    closeBtn.onclick = function() {
                        message.remove();
                    };
                    message.appendChild(closeBtn);

                    setTimeout(function() {
                    message.style.transition = 'opacity 0.5s ease';
                    message.style.opacity = '0';
                    setTimeout(function() {
                        message.remove();
                    }, 500);
                }, 5000);
            });

            // Also enhance your showAlert function to add close buttons
            const originalShowAlert = showAlert;
            showAlert = function(message, type) {
                console.log(`${type}: ${message}`);
                const alertDiv = document.createElement('div');
                alertDiv.className = `p-4 mb-3 rounded-md animate-fade-in ${
                    type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 
                    type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' : 
                    'bg-blue-100 text-blue-700 border border-blue-200'
                }`;

                // Create message and close button container
                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex justify-between items-center';

                // Add message
                const messageSpan = document.createElement('span');
                messageSpan.textContent = message;
                contentDiv.appendChild(messageSpan);

                // Add close button
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '&times;';
                closeBtn.className = 'ml-2 text-xl font-medium';
                closeBtn.onclick = function() {
                    alertDiv.remove();
                };
                contentDiv.appendChild(closeBtn);

                // Add content to alert
                alertDiv.appendChild(contentDiv);

                // Add to page if there's a messages container
                const messagesContainer = document.querySelector('.messages-container');
                if (messagesContainer) {
                    messagesContainer.appendChild(alertDiv);
                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        alertDiv.style.transition = 'opacity 0.5s ease';
                        alertDiv.style.opacity = '0';
                        setTimeout(() => alertDiv.remove(), 500);
                        }, 5000);
                } else {
                        // Fallback - use alert
                        alert(`${type.toUpperCase()}: ${message}`);
                }
            };
                
            
            // Company selection change
            companySelect.addEventListener('change', function() {
                if (existingKbSection.classList.contains('hidden') === false) {
                    loadKnowledgeBases();
                }
            });
            
            // "Use Existing" button click
            useExistingBtn.addEventListener('click', function() {
                existingKbSection.classList.remove('hidden');
                loadKnowledgeBases();
            });
            
            // "Create New" button click
            createNewBtn.addEventListener('click', function() {
                const selectedCompany = companySelect.value;
                window.location.href = `/create-knowledge-base/?company=${encodeURIComponent(selectedCompany)}`;
            });
            
            // Generate Excel Report button
            generateReportBtn.addEventListener('click', function() {
                const company = document.getElementById('company').value;
                const kbSelect = document.getElementById('kb-select');
                
                if (!company) {
                    showAlert('Please select a company first.', 'error');
                    return;
                }
                
                if (!kbSelect.value) {
                    showAlert('Please select a knowledge base first.', 'error');
                    return;
                }
                
                
                showAlert('Generating Excel report... This may take a minute.', 'info');
                
                fetch('/generate-report/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        company: company,
                        kb_name: kbSelect.options[kbSelect.selectedIndex].text,
                        report_type: 'excel'
                    })
                })
                .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showAlert('Excel report generated successfully!', 'success');
                                
                                // Create download link for the report
                                const downloadPath = data.report_path;
                                const downloadUrl = `/download-report/${encodeURIComponent(downloadPath)}/`;
                                
                                // Create and trigger download
                                window.location.href = downloadUrl;

                                // Update the reports list after a delay
                                setTimeout(() => {
                                    loadReports();
                                }, 3000);
                                
                            } else {
                                showAlert(`Error: ${data.message}`, 'error');
                            }
                        })
                    
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('An error occurred. Please try again.', 'error');
                });
            });
             // Company selection change
                companySelect.addEventListener('change', function() {
                    console.log('Company changed to:', companySelect.value);
                    if (!existingKbSection.classList.contains('hidden')) {
                        loadKnowledgeBases();
                    }
            });
            
            // Send message functionality
            sendMessageBtn.addEventListener('click', sendMessage);
                userInput.addEventListener('keydown', function(e) {
                // If Enter is pressed without Shift key
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Prevent default behavior (line break)
                    sendMessage();
                }
                setTimeout(() => {
                        this.style.height = 'auto';
                        const newHeight = Math.min(200, this.scrollHeight); // Cap at 200px height
                        this.style.height = newHeight + 'px';
                    }, 0);
            });
             // Add company form submission
            document.getElementById('add-company-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const companyName = document.getElementById('new-company-input').value.trim();
                if (!companyName) {
                    showAlert('Please enter a company name', 'error');
                    return;
                }
                
                // Create form data
                const formData = new FormData();
                formData.append('company_name', companyName);
                
                // Send Ajax request
                fetch('/add-company/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Add option to select dropdown
                        const option = document.createElement('option');
                        option.value = data.company_name;
                        option.textContent = data.company_name;
                        document.getElementById('company').appendChild(option);
                        
                        // Select the new company
                        document.getElementById('company').value = data.company_name;
                        
                        // Clear input
                        document.getElementById('new-company-input').value = '';
                        
                        // Show success message
                        showAlert(data.message, 'success');
                    } else {
                        showAlert(data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('An error occurred. Please try again.', 'error');
                });
            });
        });

    </script>
</body>
</html>
